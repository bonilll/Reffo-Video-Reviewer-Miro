<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# Reffo (reffo.studio) – Convex + Clerk

This project combines a React/Vite front-end with a Convex backend and Clerk authentication to deliver a collaborative video review workflow with annotations, threaded comments, and frame-accurate navigation.

## Prerequisites

- Node.js 18+
- Convex CLI (`npm install -g convex`, optional but useful)
- Clerk account with a publishable key (Clerk SDKs supporting Session JWT V2)
- MinIO (or any S3-compatible storage) credentials

## Environment Variables

Create a `.env.local` in the project root. The template currently contains sensible defaults for local development:

```bash
# Convex local deployment
VITE_CONVEX_URL=http://127.0.0.1:3210
CONVEX_DEPLOYMENT=local:local-aleteam-videoreviewer

# Clerk
VITE_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_JWT_ISSUER=https://clerk.accounts.dev

# MinIO / S3
MINIO_ENDPOINT=https://s3.reffo.studio
MINIO_ACCESS_KEY=...
MINIO_SECRET_KEY=...
MINIO_BUCKET=video-review-bucket
MINIO_REGION=us-east-1
MINIO_PUBLIC_URL=https://s3.reffo.studio/video-review-bucket
```

### Dev vs deploy (Convex Cloud vs self-hosted)

Vite loads environment files automatically based on the mode:

- `npm run dev` (mode `development`) loads `.env.local`
- `npm run build` (mode `production`) also loads `.env.production.local` which **overrides** values from `.env.local`

To avoid commenting/uncommenting Convex URLs every time you deploy:

- keep development values in `.env.local` (e.g. `VITE_CONVEX_URL=https://<name>.convex.cloud`)
- put deploy overrides in `.env.production.local` (e.g. `VITE_CONVEX_SELF_HOSTED_URL=https://convex-api.reffo.studio`)

Variables used by this repo:

- `VITE_CONVEX_URL` (Convex Cloud base URL, dev)
- `VITE_CONVEX_SELF_HOSTED_URL` (self-hosted Convex base URL, prod override)
- `VITE_CONVEX_HTTP_URL` (base URL for HTTP Actions; for Convex Cloud it is derived by replacing `.convex.cloud` -> `.convex.site`)

Note: the serverless routes under `api/*` read these from `process.env` in production. If you deploy them (e.g. on Vercel), set the same variables in your deploy environment too.

If you deploy the Convex backend to a self-hosted instance from your terminal, you can use:

```bash
npm run convex:deploy:selfhosted
```

For Convex cloud development, use:

```bash
npm run convex:dev
```

This repo keeps `CONVEX_DEPLOYMENT` out of `.env.local` to avoid conflicts with self-hosted deploy. The Convex CLI reads `.env.local` by default, so `CONVEX_DEPLOYMENT` must live in a separate env file (see `.env.convex.dev.local`).

For the Convex runtime to access storage credentials, set them in the deployment environment (run while `npx convex dev` is active):

```bash
CONVEX_DEPLOYMENT=local:local-aleteam-videoreviewer npx convex env set MINIO_ENDPOINT https://s3.reffo.studio
CONVEX_DEPLOYMENT=local:local-aleteam-videoreviewer npx convex env set MINIO_ACCESS_KEY <access_key>
CONVEX_DEPLOYMENT=local:local-aleteam-videoreviewer npx convex env set MINIO_SECRET_KEY <secret_key>
CONVEX_DEPLOYMENT=local:local-aleteam-videoreviewer npx convex env set MINIO_BUCKET video-review-bucket
CONVEX_DEPLOYMENT=local:local-aleteam-videoreviewer npx convex env set MINIO_REGION us-east-1
CONVEX_DEPLOYMENT=local:local-aleteam-videoreviewer npx convex env set MINIO_PUBLIC_URL https://s3.reffo.studio/video-review-bucket
CONVEX_DEPLOYMENT=local:local-aleteam-videoreviewer npx convex env set CLERK_JWT_ISSUER https://clerk.accounts.dev
```

## Local Development

```bash
# install dependencies
npm install

# start the Convex dev backend (in a dedicated terminal)
npx convex dev

# run the Vite dev server
npm run dev
```

The app is available at `http://localhost:5173`. When developing on another device in the network, make sure to expose both the Vite server (defaults to 5173) and Convex dev server (defaults to 3210).

### Clerk compatibility notes

- Session JWT V2 requires compatible SDKs. This repo pins `@clerk/clerk-react@^5.61.0`, which includes the required Clerk.js version.
- If you turned on Client Trust (credential stuffing protection) in the Clerk dashboard, sign‑in may require a second factor on new devices. The app now delegates such cases to Clerk’s UI automatically.

## Production Build

```bash
npm run build
npm run preview
```

## Notes

- Uploads are streamed directly to MinIO via pre-signed URLs generated by Convex actions.
- Convex handles persistence for projects, videos, annotations, and comments. Data is scoped per Clerk user.
- Undo/redo controls are currently placeholders; annotations and comments persist immediately to the backend.
